"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}!function i(s,o,u){function l(t,e){if(!o[t]){if(!s[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(c)return c(t,!0);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}var a=o[t]={exports:{}};s[t][0].call(a.exports,function(e){return l(s[t][1][e]||e)},a,a.exports,i,s,o,u)}return o[t].exports}for(var c="function"==typeof require&&require,e=0;e<u.length;e++)l(u[e]);return l}({1:[function(e,t,r){var o=e("./evaluator/Evaluator"),n=e("./Lexer"),u=e("./parser/Parser"),a=e("./grammar").elements,i=e("./PromiseSync"),s=function(){function e(){_classCallCheck(this,e),this._customGrammar=null,this._lexer=null,this._transforms={}}return _createClass(e,[{key:"addBinaryOp",value:function(e,t,r){this._addGrammarElement(e,{type:"binaryOp",precedence:t,eval:r})}},{key:"addUnaryOp",value:function(e,t){this._addGrammarElement(e,{type:"unaryOp",weight:1/0,eval:t})}},{key:"addTransform",value:function(e,t){this._transforms[e]=t}},{key:"addTransforms",value:function(e){for(var t in e)e.hasOwnProperty(t)&&(this._transforms[t]=e[t])}},{key:"getTransform",value:function(e){return this._transforms[e]}},{key:"eval",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this._eval(e,t,Promise)}},{key:"evalSync",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=this._eval(e,t,i);if(r.error)throw r.error;return r.value}},{key:"removeOp",value:function(e){var t=this._getCustomGrammar();!t[e]||"binaryOp"!==t[e].type&&"unaryOp"!==t[e].type||(delete t[e],this._lexer=null)}},{key:"_addGrammarElement",value:function(e,t){this._getCustomGrammar()[e]=t,this._lexer=null}},{key:"_eval",value:function(e,t,r){var n=this,a=this._getGrammar(),i=new u(a),s=new o(a,this._transforms,t,void 0,r);return r.resolve().then(function(){return i.addTokens(n._getLexer().tokenize(e)),s.eval(i.complete())})}},{key:"_getCustomGrammar",value:function(){if(!this._customGrammar)for(var e in this._customGrammar={},a)a.hasOwnProperty(e)&&(this._customGrammar[e]=a[e]);return this._customGrammar}},{key:"_getGrammar",value:function(){return this._customGrammar||a}},{key:"_getLexer",value:function(){return this._lexer||(this._lexer=new n(this._getGrammar())),this._lexer}}]),e}();t.exports=new s,t.exports.Jexl=s},{"./Lexer":2,"./PromiseSync":3,"./evaluator/Evaluator":4,"./grammar":6,"./parser/Parser":7}],2:[function(e,t,r){var n=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,a=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/,i=/\\\\/,s=["'(?:(?:\\\\')?[^'])*'",'"(?:(?:\\\\")?[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b"],o=["\\b[a-zA-Z_\\$][a-zA-Z0-9_\\$]*\\b","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],u=["binaryOp","unaryOp","openParen","openBracket","question","colon"],l=function(){function t(e){_classCallCheck(this,t),this._grammar=e}return _createClass(t,[{key:"getElements",value:function(e){var t=this._getSplitRegex();return e.split(t).filter(function(e){return e})}},{key:"getTokens",value:function(e){for(var t=[],r=!1,n=0;n<e.length;n++)this._isWhitespace(e[n])?t.length&&(t[t.length-1].raw+=e[n]):"-"===e[n]&&this._isNegative(t)?r=!0:(r&&(e[n]="-"+e[n],r=!1),t.push(this._createToken(e[n])));return r&&t.push(this._createToken("-")),t}},{key:"tokenize",value:function(e){var t=this.getElements(e);return this.getTokens(t)}},{key:"_createToken",value:function(e){var t={type:"literal",value:e,raw:e};if('"'===e[0]||"'"===e[0])t.value=this._unquote(e);else if(e.match(n))t.value=parseFloat(e);else if("true"===e||"false"===e)t.value="true"===e;else if(this._grammar[e])t.type=this._grammar[e].type;else{if(!e.match(a))throw new Error("Invalid expression token: ".concat(e));t.type="identifier"}return t}},{key:"_escapeRegExp",value:function(e){return(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).match(a)&&(e="\\b"+e+"\\b"),e}},{key:"_getSplitRegex",value:function(){var t=this;if(!this._splitRegex){var e=Object.keys(this._grammar).sort(function(e,t){return t.length-e.length}).map(function(e){return t._escapeRegExp(e)},this);this._splitRegex=new RegExp("("+[s.join("|"),e.join("|"),o.join("|")].join("|")+")")}return this._splitRegex}},{key:"_isNegative",value:function(t){return!t.length||u.some(function(e){return e===t[t.length-1].type})}},{key:"_isWhitespace",value:function(e){for(var t=0;t<e.length;t++)if(" "!==e[t])return!1;return!0}},{key:"_unquote",value:function(e){var t=e[0],r=new RegExp("\\\\"+t,"g");return e.substr(1,e.length-2).replace(r,t).replace(i,"\\")}}]),t}();t.exports=l},{}],3:[function(e,t,r){var n=function(){function t(e){_classCallCheck(this,t),e(this._resolve.bind(this),this._reject.bind(this))}return _createClass(t,[{key:"catch",value:function(e){if(this.error)try{this._resolve(e(this.error))}catch(e){this._reject(e)}return this}},{key:"then",value:function(e,t){if(!this.error)try{this._resolve(e(this.value))}catch(e){this._reject(e)}return t&&this.catch(t),this}},{key:"_reject",value:function(e){this.value=void 0,this.error=e}},{key:"_resolve",value:function(e){e instanceof t?this._resolve(e.value):(this.value=e,this.error=void 0)}}]),t}();n.all=function(t){return new n(function(e){return e(t.map(function(e){for(;e instanceof n;)e=e.value;return e}))})},n.resolve=function(t){return new n(function(e){return e(t)})},n.reject=function(r){return new n(function(e,t){return t(r)})},t.exports=n},{}],4:[function(e,t,r){var n=e("./handlers"),a=function(){function s(e,t,r,n){var a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:Promise;_classCallCheck(this,s),this._grammar=e,this._transforms=t||{},this._context=r||{},this._relContext=n||this._context,this.Promise=a}return _createClass(s,[{key:"eval",value:function(e){var t=this;return this.Promise.resolve().then(function(){return n[e.type].call(t,e)})}},{key:"evalArray",value:function(e){var t=this;return this.Promise.all(e.map(function(e){return t.eval(e)}))}},{key:"evalMap",value:function(t){var r=this,n=Object.keys(t),a={},e=n.map(function(e){return r.eval(t[e])});return this.Promise.all(e).then(function(e){return e.forEach(function(e,t){a[n[t]]=e}),a})}},{key:"_filterRelative",value:function(n,r){var a=this,i=[];return Array.isArray(n)||(n=void 0===n?[]:[n]),n.forEach(function(e){var t=new s(a._grammar,a._transforms,a._context,e);i.push(t.eval(r))}),this.Promise.all(i).then(function(e){var r=[];return e.forEach(function(e,t){e&&r.push(n[t])}),r})}},{key:"_filterStatic",value:function(t,e){return this.eval(e).then(function(e){return"boolean"==typeof e?e?t:void 0:t[e]})}}]),s}();t.exports=a},{"./handlers":5}],5:[function(e,t,r){r.ArrayLiteral=function(e){return this.evalArray(e.value)},r.BinaryExpression=function(t){var r=this;return this.Promise.all([this.eval(t.left),this.eval(t.right)]).then(function(e){return r._grammar[t.operator].eval(e[0],e[1])})},r.ConditionalExpression=function(t){var r=this;return this.eval(t.test).then(function(e){return e?t.consequent?r.eval(t.consequent):e:r.eval(t.alternate)})},r.FilterExpression=function(t){var r=this;return this.eval(t.subject).then(function(e){return t.relative?r._filterRelative(e,t.expr):r._filterStatic(e,t.expr)})},r.Identifier=function(t){return t.from?this.eval(t.from).then(function(e){if(void 0!==e)return Array.isArray(e)&&(e=e[0]),e[t.value]}):t.relative?this._relContext[t.value]:this._context[t.value]},r.Literal=function(e){return e.value},r.ObjectLiteral=function(e){return this.evalMap(e.value)},r.Transform=function(e){var t=this._transforms[e.name];if(!t)throw new Error("Transform ".concat(e.name," is not defined."));return this.Promise.all([this.eval(e.subject),this.evalArray(e.args||[])]).then(function(e){return t.apply(null,[e[0]].concat(e[1]))})},r.UnaryExpression=function(t){var r=this;return this.eval(t.right).then(function(e){return r._grammar[t.operator].eval(e)})}},{}],6:[function(e,t,r){r.elements={".":{type:"dot"},"[":{type:"openBracket"},"]":{type:"closeBracket"},"|":{type:"pipe"},"{":{type:"openCurl"},"}":{type:"closeCurl"},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen"},")":{type:"closeParen"},"?":{type:"question"},"+":{type:"binaryOp",precedence:30,eval:function(e,t){return e+t}},"-":{type:"binaryOp",precedence:30,eval:function(e,t){return e-t}},"*":{type:"binaryOp",precedence:40,eval:function(e,t){return e*t}},"/":{type:"binaryOp",precedence:40,eval:function(e,t){return e/t}},"//":{type:"binaryOp",precedence:40,eval:function(e,t){return Math.floor(e/t)}},"%":{type:"binaryOp",precedence:50,eval:function(e,t){return e%t}},"^":{type:"binaryOp",precedence:50,eval:function(e,t){return Math.pow(e,t)}},"==":{type:"binaryOp",precedence:20,eval:function(e,t){return e==t}},"!=":{type:"binaryOp",precedence:20,eval:function(e,t){return e!=t}},">":{type:"binaryOp",precedence:20,eval:function(e,t){return t<e}},">=":{type:"binaryOp",precedence:20,eval:function(e,t){return t<=e}},"<":{type:"binaryOp",precedence:20,eval:function(e,t){return e<t}},"<=":{type:"binaryOp",precedence:20,eval:function(e,t){return e<=t}},"&&":{type:"binaryOp",precedence:10,eval:function(e,t){return e&&t}},"||":{type:"binaryOp",precedence:10,eval:function(e,t){return e||t}},in:{type:"binaryOp",precedence:20,eval:function(t,e){return"string"==typeof e?-1!==e.indexOf(t):!!Array.isArray(e)&&e.some(function(e){return e===t})}},"!":{type:"unaryOp",precedence:1/0,eval:function(e){return!e}}}},{}],7:[function(e,t,r){var s=e("./handlers"),o=e("./states").states,n=function(){function n(e,t,r){_classCallCheck(this,n),this._grammar=e,this._state="expectOperand",this._tree=null,this._exprStr=t||"",this._relative=!1,this._stopMap=r||{}}return _createClass(n,[{key:"addToken",value:function(e){if("complete"===this._state)throw new Error("Cannot add a new token to a completed Parser");var t=o[this._state],r=this._exprStr;if(this._exprStr+=e.raw,t.subHandler){this._subParser||this._startSubExpression(r);var n=this._subParser.addToken(e);if(n){if(this._endSubExpression(),this._parentStop)return n;this._state=n}}else{if(!t.tokenTypes[e.type]){if(this._stopMap[e.type])return this._stopMap[e.type];throw new Error("Token ".concat(e.raw," (").concat(e.type,") unexpected in expression: ").concat(this._exprStr))}var a=t.tokenTypes[e.type],i=s[e.type];a.handler&&(i=a.handler),i&&i.call(this,e),a.toState&&(this._state=a.toState)}return!1}},{key:"addTokens",value:function(e){e.forEach(this.addToken,this)}},{key:"complete",value:function(){if(this._cursor&&!o[this._state].completable)throw new Error("Unexpected end of expression: ".concat(this._exprStr));return this._subParser&&this._endSubExpression(),this._state="complete",this._cursor?this._tree:null}},{key:"isRelative",value:function(){return this._relative}},{key:"_endSubExpression",value:function(){o[this._state].subHandler.call(this,this._subParser.complete()),this._subParser=null}},{key:"_placeAtCursor",value:function(e){this._cursor?(this._cursor.right=e,this._setParent(e,this._cursor)):this._tree=e,this._cursor=e}},{key:"_placeBeforeCursor",value:function(e){this._cursor=this._cursor._parent,this._placeAtCursor(e)}},{key:"_setParent",value:function(e,t){Object.defineProperty(e,"_parent",{value:t,writable:!0})}},{key:"_startSubExpression",value:function(e){var t=o[this._state].endStates;t||(this._parentStop=!0,t=this._stopMap),this._subParser=new n(this._grammar,e,t)}}]),n}();t.exports=n},{"./handlers":8,"./states":9}],8:[function(e,t,r){r.argVal=function(e){this._cursor.args.push(e)},r.arrayStart=function(){this._placeAtCursor({type:"ArrayLiteral",value:[]})},r.arrayVal=function(e){e&&this._cursor.value.push(e)},r.binaryOp=function(e){for(var t=this._grammar[e.value].precedence||0,r=this._cursor._parent;r&&r.operator&&this._grammar[r.operator].precedence>=t;)r=(this._cursor=r)._parent;var n={type:"BinaryExpression",operator:e.value,left:this._cursor};this._setParent(this._cursor,n),this._cursor=r,this._placeAtCursor(n)},r.dot=function(){this._nextIdentEncapsulate=this._cursor&&"UnaryExpression"!==this._cursor.type&&("BinaryExpression"!==this._cursor.type||"BinaryExpression"===this._cursor.type&&this._cursor.right),this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},r.filter=function(e){this._placeBeforeCursor({type:"FilterExpression",expr:e,relative:this._subParser.isRelative(),subject:this._cursor})},r.identifier=function(e){var t={type:"Identifier",value:e.value};this._nextIdentEncapsulate?(t.from=this._cursor,this._placeBeforeCursor(t),this._nextIdentEncapsulate=!1):(this._nextIdentRelative&&(t.relative=!0,this._nextIdentRelative=!1),this._placeAtCursor(t))},r.literal=function(e){this._placeAtCursor({type:"Literal",value:e.value})},r.objKey=function(e){this._curObjKey=e.value},r.objStart=function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},r.objVal=function(e){this._cursor.value[this._curObjKey]=e},r.subExpression=function(e){this._placeAtCursor(e)},r.ternaryEnd=function(e){this._cursor.alternate=e},r.ternaryMid=function(e){this._cursor.consequent=e},r.ternaryStart=function(){this._tree={type:"ConditionalExpression",test:this._tree},this._cursor=this._tree},r.transform=function(e){this._placeBeforeCursor({type:"Transform",name:e.value,args:[],subject:this._cursor})},r.unaryOp=function(e){this._placeAtCursor({type:"UnaryExpression",operator:e.value})}},{}],9:[function(e,t,r){var n=e("./handlers");r.states={expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:n.objStart},dot:{toState:"traverse"},openBracket:{toState:"arrayVal",handler:n.arrayStart}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"},question:{toState:"ternaryMid",handler:n.ternaryStart}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:n.transform}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:n.objKey},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postTransformArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"},question:{toState:"ternaryMid",handler:n.ternaryStart}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:n.filter,endStates:{closeBracket:"identifier"}},subExpression:{subHandler:n.subExpression,endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:n.argVal,endStates:{comma:"argVal",closeParen:"postTransformArgs"}},objVal:{subHandler:n.objVal,endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}},arrayVal:{subHandler:n.arrayVal,endStates:{comma:"arrayVal",closeBracket:"expectBinOp"}},ternaryMid:{subHandler:n.ternaryMid,endStates:{colon:"ternaryEnd"}},ternaryEnd:{subHandler:n.ternaryEnd,completable:!0}}},{"./handlers":8}],10:[function(e,t,r){var n=e("../node_modules/jexl/lib/Jexl.js");window.Jexl=n},{"../node_modules/jexl/lib/Jexl.js":1}]},{},[10]);